#!/bin/bash
#
# Copyright IBM Corp. All Rights Reserved.
#
# SPDX-License-Identifier: Apache-2.0
#

function filterGeneratedFiles {
    for f in $@; do
        head -n2 $f | grep -qE 'Code generated by.*DO NOT EDIT' || echo $f
    done
}

CHECK=$(git diff --name-only --diff-filter=ACMRTUXB HEAD)
CHECK=$(filterGeneratedFiles "$CHECK")

echo "Checking Go files for license headers ..."
missing=`echo "$CHECK" | xargs ls -d 2>/dev/null | xargs grep -L "Apache License"`
if [ -z "$missing" ]; then
   echo "All go files have license headers"
   exit 0
fi
echo "The following files are missing license headers:"
echo "$missing"
exit 1
