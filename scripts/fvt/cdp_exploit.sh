#!/bin/bash
checkMsg() {
awk -v rc=-1 -v m="$1" '$0~m {rc=0} ; {print}; END {exit rc}'
}
RC=0
httpPort=3755
export CA_CFG_PATH=/tmp/oom
export FABRIC_CA_CLIENT_HOME=/tmp/oom/admin
. ./scripts/fvt/fabric-ca_utils
mkdir -p /FVT/crl/
cp $GOPATH/src/github.com/hyperledger/fabric-ca/testdata/crl.pem /FVT/crl/crl.pem
./scripts/fvt/utils/pki -f newcert -p admin -t ec -l 256 -n '/C=US/CN=admin/ST=North Carolina/O=Hyperledger/OU=Fabric/CN=admin/' -x <<EOF
127.0.0.2

admin.fabric.raleigh.ibm.com
admin@fab-client.raleigh.ibm.com
Y
EOF

# Start the default server and check to see if CRL retrieval works if size limit is appropriate
# However, register will fake because we use a 'hacked' enrollment certificate
./scripts/fvt/fabric-ca_setup.sh -I -X -S -D
enroll
admin_keyfile="$(find /tmp/oom/admin/msp/keystore -type f)"
admin_certfile="/tmp/oom/admin/msp/signcerts/cert.pem"
hacker_admin_keyfile="/root/adminkey.pem"
hacker_admin_certfile="/root/admincert.pem"
cp $hacker_admin_keyfile $admin_keyfile
cp $hacker_admin_certfile $admin_certfile
cd /
python -m SimpleHTTPServer $httpPort &
pollServer httpserver 127.0.0.1 3755 10
register admin user1 2>&1 | checkMsg "Error: Error response from server was: Authorization failure"
test $? -ne 0 && ErrorMsg "Failed to return correct error"

# Lower the CRL size limit on server and check to see that server does not continue to proceed with retrieving CRL list
export FABRIC_CA_SERVER_CRLSIZELIMIT=10
cd $GOPATH/src/github.com/hyperledger/fabric-ca
./scripts/fvt/fabric-ca_setup.sh -K
./scripts/fvt/fabric-ca_setup.sh -S -D
cd bin/fabric-ca
fabric-ca-client enroll -u http://admin2:adminpw2@localhost:7054 -d
admin_keyfile="$(find /tmp/oom/admin/msp/keystore -type f)"
admin_certfile="/tmp/oom/admin/msp/signcerts/cert.pem"
hacker_admin_keyfile="/root/adminkey.pem"
hacker_admin_certfile="/root/admincert.pem"
cp $hacker_admin_keyfile $admin_keyfile
cp $hacker_admin_certfile $admin_certfile
# cd bin/fabric-ca
fabric-ca-client register -u http://localhost:7054 --id.name admin --id.type user --id.affiliation org1 2>&1 | checkMsg "Error: Error response from server was: The size of the requested CRL list size is"
test $? -ne 0 && ErrorMsg "Failed to return correct error"

CleanUp $RC
exit $RC